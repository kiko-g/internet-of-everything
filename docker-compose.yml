version: "3"
services:
  # Edge Broker
  mosquitto:
    image: eclipse-mosquitto:1.6
    ports:
      - "1883:1883"
    volumes:
      - ./mosquitto/:/mosquitto/
      - ./mosquitto/data:/mosquitto/data 
      - ./mosquitto/log:/mosquitto/log 
    container_name: "mosquitto"

  # Emulator Server
  # TODO
  mongo: 
    image: mongo:5.0.5
    restart: always  
    env_file:
      - ./failure/.env
    ports:
      - ${DB_PORT}:${DB_PORT}
    environment:
      MONGO_INITDB_ROOT_USERNAME: "${DB_USERNAME}"
      MONGO_INITDB_ROOT_PASSWORD: "${DB_PASSWORD}"

  mongo-express:
      image: mongo-express
      restart: always
      ports:
        - 8081:8081
      environment:
        ME_CONFIG_MONGODB_ADMINUSERNAME: "${DB_USERNAME}"
        ME_CONFIG_MONGODB_ADMINPASSWORD: "${DB_PASSWORD}"
        ME_CONFIG_MONGODB_URL: "mongodb://${DB_USERNAME}:${DB_PASSWORD}@mongo:${DB_PORT}"

  # Failure Analysis
  machines:
    build: ./failure/
    command: sh -c "gradle runMachineSensors"
    volumes:
      - ./src/:/failure/edge/src/
    container_name: "machine-sensors"

  products:
    build: ./failure/
    command: sh -c "gradle runProductSensors"
    volumes:
      - ./src/:/failure/edge/src/
    container_name: "product-sensors"

  failure-service:
    build: ./failure/
    command: sh -c "gradle runFailureService"
    env_file:
     - ./failure/.env
    ports: 
      - ${SERVER_PORT}:${SERVER_PORT}
    volumes:
      - ./src/:/failure/edge/src/
    container_name: "failure-service"
    depends_on:
      - mongo
    
